{% extends "base_authenticated.html" %}
{% load static %}

{% block main_content %}
<div class="flex">
    {% if is_own_profile %}
    <div class="w-3/5 flex flex-col items-center m-5">
        <!--Profile card-->
        <div class="w-full flex items-center justify-center bg-slate-400 rounded-lg p-4 space-x-4">
            <!--Image Container-->
            <div class="flex justify-center w-full">
                <img src="{% if user.profile_img %}{{ user.profile_img.url }}{% else %}{% static 'images/default_user.png' %}{% endif %}" alt="Profile Image" class="w-48 h-48 rounded-full">
            </div>
            <!--Text Container-->
            <div class="text-center w-full mt-4">
                <div class="font-bold text-5xl mb-2">{{ user.first_name }} {{ user.last_name }}</div>
                <div class="whitespace-normal p-2">                    
                    <strong>Username:</strong> {{ user.username }}<br>
                    <strong>Account type:</strong> {% if user.is_teacher %}Teacher{% else %}Student{% endif %}<br>
                    <strong>Contact at:</strong> {{ user.email }}<br>
                    <strong>Date of Birth:</strong> {{ user.date_of_birth|date:"Y-m-d" }}<br>
                    <strong>Bio:</strong> {{ user.bio }}
                </div>
            </div>
            <!--Edit Buttons-->
            <div class="flex flex-col w-full items-center justify-center space-y-2">
                <form action="{% url 'update_profile' %}" method="get" class="w-full">
                    {% csrf_token %}
                    <button type="submit" class="w-full mb-6 text-white bg-blue-700 
                    hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg 
                    text-sm px-4 py-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800  
                ">Edit Profile</button>
                </form>
                <!--REMEMBER TO UPDATE URL-->
                <form action="{% url 'update_profile' %}" method="get" class="w-full">
                    {% csrf_token %}
                    <button type="submit" class="w-full mt-6 text-white bg-blue-700 
                    hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg 
                    text-sm px-4 py-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800                
                ">Change Password</button>
                </form>
            </div>
        </div>
        <!--Add Status Update Card-->
        <div class="w-full flex items-center justify-center bg-slate-400 rounded-lg p-4 mt-4 space-x-4">
                <form id="statusUpdateForm" action="{% url 'create_status_update' %}" method="POST">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit" class="w-full text-white bg-blue-700 
                    hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg 
                    text-sm px-4 py-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Post</button>
                </form>
        </div>
        <!-- Accompanying Fetch API-->
        <script>
            document.getElementById('statusUpdateForm').addEventListener('submit', function(e) {
                e.preventDefault();
                fetch('/api/create_status_update/', {
                    method: 'POST',
                    body: JSON.stringify({
                        'status': document.getElementById('id_status').value
                    }),
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'Content-Type': 'application/json',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        return response.json(); // For HTTP 201 Created
                    } else if (response.status === 400) {
                        return response.json().then(data => {
                            throw data; // Throw the data to be caught in the catch block
                        });
                    } else {
                        throw new Error('Something went wrong on server side.'); // For other server-side errors
                    }
                })
                .then(data => {
                    console.log('Success:', data);
                    document.getElementById('statusUpdateForm').reset(); // Reset form fields
                    // Optionally, reload the page or part of it to show the updated list of status updates
                    location.reload();
                })
                .catch(function(error) {
                    console.error('Error:', error);
                });
            });
        </script>

        {% for status_update in status_updates %}
        <!--Status Update Card-->
        <div class="w-full flex items-center justify-center bg-slate-400 rounded-lg p-4 mt-4 space-x-4">
            <!--Image Container-->
            <div class="flex justify-center w-full">
                <img src="{% if status_update.user.profile_img %}{{ status_update.user.profile_img }}{% else %}{% static 'images/default_user.png' %}{% endif %}" alt="Profile Image" class="w-24 h-24 rounded-full">
            </div>
            <!--Text Container-->
            <div class="text-center w-full mt-4">
                <div class="font-bold text-3xl mb-2">{{ status_update.user.username }}</div>
                <div class="whitespace-normal p-2">
                    {{ status_update.status }}
                </div>
                <div>{{ status_update.created_at }}</div>
            </div>
        </div>
        {% empty %}
        <p class="text-lg text-gray-800">No status updates yet.</p>
        {% endfor %}
    </div>
    <div class="w-2/5 flex flex-col items-center m-5">
        <!--Registered Courses card-->
        <div class="w-full flex flex-col items-center justify-center bg-slate-400 rounded-lg p-4 mt-4">
            <div class="text-center w-full mb-4">
                <h2 class="font-bold text-3xl">Registered Courses</h2>
            </div>
            <ul class="list-disc pl-5">
                {% for enrollment in enrolled_courses %}
                <li class="text-md text-gray-700">
                    <strong>{{ enrollment.course.course_title }}</strong> by {{ enrollment.course.teacher.first_name }} {{ enrollment.course.teacher.last_name }} - Start Date: {{ enrollment.enrolled_at }}
                </li>
                {% empty %}
                <li class="text-lg text-gray-800">No courses enrolled yet.</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% else %}

    {% endif %}
</div>
{% endblock %}